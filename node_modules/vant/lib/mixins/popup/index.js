'use strict';

exports.__esModule = true;

var _popupManager = require('./popup-manager');

var _popupManager2 = _interopRequireDefault(_popupManager);

var _popupContext = require('./popup-context');

var _popupContext2 = _interopRequireDefault(_popupContext);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

exports.default = {
  props: {
    // popup当前显示状态
    value: {
      type: Boolean,
      default: false
    },
    // 是否显示遮罩层
    overlay: {
      type: Boolean,
      default: false
    },
    /**
     * 点击遮罩层是否关闭popup
     */
    closeOnClickOverlay: {
      type: Boolean,
      default: false
    },
    zIndex: [String, Number],
    // popup滚动时是否body内容也滚动
    // 默认为不滚动
    lockOnScroll: {
      type: Boolean,
      default: true
    },
    // 防止滚动穿透
    preventScroll: {
      type: Boolean,
      default: false
    }
  },

  watch: {
    value: function value(val) {
      if (val) {
        if (this.opening) return;
        this.open();
      } else {
        if (this.closing) return;
        this.close();
      }
    }
  },

  beforeMount: function beforeMount() {
    this._popupId = 'popup-' + _popupContext2.default.plusKeyByOne('idSeed');
    _popupManager2.default.register(this._popupId, this);
  },
  data: function data() {
    return {
      opening: false,
      opened: false,
      closing: false,
      bodyOverflow: null,
      pos: {
        x: 0,
        y: 0
      }
    };
  },


  methods: {
    recordPosition: function recordPosition(e) {
      this.pos = {
        x: e.touches[0].clientX,
        y: e.touches[0].clientY
      };
    },
    watchTouchMove: function watchTouchMove(e) {
      var pos = this.pos;
      var dx = e.touches[0].clientX - pos.x;
      var dy = e.touches[0].clientY - pos.y;
      var direction = dy > 0 ? '10' : '01';
      var el = this.$el.querySelector('.scroller') || this.$el;
      var scrollTop = el.scrollTop;
      var scrollHeight = el.scrollHeight;
      var offsetHeight = el.offsetHeight;
      var isVertical = Math.abs(dx) < Math.abs(dy);

      var status = '11';

      if (scrollTop === 0) {
        status = offsetHeight >= scrollHeight ? '00' : '01';
      } else if (scrollTop + offsetHeight >= scrollHeight) {
        status = '10';
      }

      if (status !== '11' && isVertical && !(parseInt(status, 2) & parseInt(direction, 2))) {
        e.preventDefault();
        e.stopPropagation();
      }
    },

    /**
     * 显示popup
     */
    open: function open() {
      /* istanbul ignore if */
      if (this.$isServer) return;
      if (this.opened) return;

      this.opening = true;

      this.$emit('input', true);

      var zIndex = this.zIndex;

      // 如果属性中传入了`zIndex`，则覆盖`popupContext`中对应的`zIndex`
      if (zIndex) {
        _popupContext2.default.setContext('zIndex', zIndex);
      }

      // 如果显示遮罩层
      if (this.overlay) {
        if (this.closing) {
          _popupManager2.default.closeModal(this._popupId);
          this.closing = false;
        }
        _popupManager2.default.openModal(this._popupId, _popupManager2.default.nextZIndex(), this.$el);

        // 如果滚动时需要锁定
        if (this.lockOnScroll) {
          // 将原来的`bodyOverflow`存起来
          if (!this.bodyOverflow) {
            this.bodyOverflow = document.body.style.overflow;
          }

          document.body.style.overflow = 'hidden';
        }
      }

      this.$el.style.zIndex = _popupManager2.default.nextZIndex();
      this.opened = true;
      this.opening = false;

      if (this.preventScroll) {
        document.addEventListener('touchstart', this.recordPosition, false);
        document.addEventListener('touchmove', this.watchTouchMove, false);
      }
    },


    /**
     * 关闭popup
     */
    close: function close() {
      var _this = this;

      if (this.closing) return;

      this.closing = true;

      this.$emit('input', false);

      if (this.lockOnScroll) {
        setTimeout(function () {
          if (_this.overlay && _this.bodyOverflow !== 'hidden') {
            document.body.style.overflow = _this.bodyOverflow;
          }
          _this.bodyOverflow = null;
        }, 200);
      }

      this.opened = false;
      this.doAfterClose();
    },
    doAfterClose: function doAfterClose() {
      this.closing = false;
      _popupManager2.default.closeModal(this._popupId);

      if (this.preventScroll) {
        document.removeEventListener('touchstart', this.recordPosition, false);
        document.removeEventListener('touchmove', this.watchTouchMove, false);
      }
    }
  },

  beforeDestroy: function beforeDestroy() {
    _popupManager2.default.deregister(this._popupId);
    _popupManager2.default.closeModal(this._popupId);

    if (this.overlay && this.bodyOverflow !== null && this.bodyOverflow !== 'hidden') {
      document.body.style.overflow = this.bodyOverflow;
    }
    this.bodyOverflow = null;
  }
};